<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FocusQuest">
<meta name="theme-color" content="#0a0a1a">
<link rel="manifest" id="manifestLink">
<title>Focus Quest - é›†ä¸­ã‚¯ã‚¨ã‚¹ãƒˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DotGothic16&family=Noto+Sans+JP:wght@400;700;900&family=Orbitron:wght@700;900&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg-dark:#0a0a1a;--bg-card:#12122a;--bg-card2:#1a1a3a;--accent1:#00d4ff;--accent2:#ff2d95;--accent3:#39ff14;--accent4:#ffe600;--accent5:#b24dff;--gold:#ffd700;--text-main:#e0e0f0;--text-dim:#7878a0;--danger:#ff4444;--border-glow:rgba(0,212,255,.25);--font-display:'Orbitron','Press Start 2P',monospace;--font-pixel:'Press Start 2P',monospace;--font-body:'Noto Sans JP',sans-serif;--radius:14px;--card-shadow:0 2px 20px rgba(0,0,0,.3);}
.theme-kids{--bg-dark:#fef9ef;--bg-card:#fff;--bg-card2:#fff5e0;--accent1:#4dc8ff;--accent2:#ff6b9d;--accent3:#5dd662;--accent4:#ffcb3b;--accent5:#c084fc;--gold:#ffb800;--text-main:#3a3535;--text-dim:#9c8f8f;--danger:#ff5c5c;--border-glow:rgba(77,200,255,.25);--font-display:'Nunito',sans-serif;--font-pixel:'DotGothic16','Press Start 2P',monospace;--font-body:'Nunito','Noto Sans JP',sans-serif;--radius:20px;--card-shadow:0 4px 16px rgba(0,0,0,.08);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:var(--font-body);background:var(--bg-dark);color:var(--text-main);min-height:100dvh;overflow-x:hidden;transition:background .5s,color .5s;}
body:not(.theme-kids)::before{content:'';position:fixed;inset:0;background:linear-gradient(rgba(0,212,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.03) 1px,transparent 1px);background-size:24px 24px;pointer-events:none;z-index:0;}
body.theme-kids::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 20% 30%,rgba(77,200,255,.08),transparent 50%),radial-gradient(circle at 80% 70%,rgba(255,107,157,.08),transparent 50%);pointer-events:none;z-index:0;}
.app{position:relative;z-index:1;max-width:480px;margin:0 auto;padding:12px 16px 110px;}
/* User Switcher */
.top-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.help-btn{background:var(--bg-card);border:1.5px solid var(--border-glow);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;transition:all .2s;color:var(--text-dim);flex-shrink:0;}
.help-btn:hover{border-color:var(--accent1);color:var(--accent1);}
.help-modal-body{text-align:left;max-height:60vh;overflow-y:auto;padding-right:4px;}
.help-modal-body::-webkit-scrollbar{width:4px;}.help-modal-body::-webkit-scrollbar-thumb{background:var(--text-dim);border-radius:2px;}
.help-section{margin-bottom:16px;}
.help-section-title{font-size:14px;font-weight:800;color:var(--accent1);margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.help-section p{font-size:12px;line-height:1.7;color:var(--text-dim);margin-bottom:4px;}
.help-section .help-highlight{color:var(--text-main);font-weight:700;}
.user-switcher{display:flex;gap:6px;margin-bottom:10px;padding:8px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:var(--radius);box-shadow:var(--card-shadow);}
.user-btn{flex:1;padding:8px 4px;background:transparent;border:2px solid transparent;border-radius:10px;color:var(--text-dim);font-family:var(--font-body);font-size:12px;font-weight:700;cursor:pointer;transition:all .3s;text-align:center;display:flex;flex-direction:column;align-items:center;gap:3px;}
.user-btn .user-emoji{font-size:24px;}
.user-btn .user-name{max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-btn.active{border-color:var(--accent1);color:var(--text-main);background:var(--bg-card2);box-shadow:0 0 10px rgba(0,212,255,.12);}
.user-btn .user-lv{font-family:var(--font-pixel);font-size:7px;color:var(--accent3);}
.user-edit-btn{background:none;border:none;color:var(--text-dim);font-size:14px;cursor:pointer;padding:4px;align-self:center;transition:color .2s;}
.user-edit-btn:hover{color:var(--accent1);}
/* User Edit Modal */
.ue-field{margin-bottom:14px;text-align:left;}
.ue-label{font-size:12px;color:var(--text-dim);margin-bottom:6px;display:block;}
.ue-input{width:100%;padding:10px 12px;background:var(--bg-card2);border:1.5px solid var(--border-glow);border-radius:10px;color:var(--text-main);font-family:var(--font-body);font-size:15px;outline:none;transition:border-color .3s;}
.ue-input:focus{border-color:var(--accent1);}
.ue-emoji-grid{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
.ue-emoji-opt{width:40px;height:40px;border:2px solid transparent;border-radius:10px;background:var(--bg-card2);display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all .2s;}
.ue-emoji-opt.sel{border-color:var(--accent1);background:rgba(0,212,255,.1);}
.mode-switcher{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px;font-size:13px;font-weight:700;}
.mode-switcher label{color:var(--text-dim);cursor:pointer;transition:color .3s;}.mode-switcher label.active-label{color:var(--accent1);}
.switch-track{width:52px;height:28px;background:var(--bg-card2);border:2px solid var(--border-glow);border-radius:14px;position:relative;cursor:pointer;transition:all .3s;}
.switch-thumb{width:20px;height:20px;background:var(--accent1);border-radius:50%;position:absolute;top:2px;left:2px;transition:transform .3s,background .3s;box-shadow:0 0 8px rgba(0,212,255,.5);}
.switch-track.kids .switch-thumb{transform:translateX(24px);background:var(--accent2);box-shadow:0 0 8px rgba(255,107,157,.5);}
.profile-bar{display:flex;gap:8px;margin-bottom:12px;}
.profile-btn{flex:1;padding:10px;background:var(--bg-card);border:2px solid transparent;border-radius:var(--radius);color:var(--text-dim);font-family:var(--font-body);font-size:13px;font-weight:700;cursor:pointer;transition:all .3s;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;}
.profile-btn .pem{font-size:22px;}.profile-btn.active{border-color:var(--accent1);color:var(--text-main);background:var(--bg-card2);box-shadow:0 0 12px rgba(0,212,255,.15);}
.status-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:var(--radius);margin-bottom:14px;position:relative;overflow:hidden;box-shadow:var(--card-shadow);}
.status-bar::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent5));}
.pi{display:flex;align-items:center;gap:10px;}
.pa{width:44px;height:44px;background:linear-gradient(135deg,var(--accent1),var(--accent5));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 12px rgba(0,212,255,.3);transition:all .3s;}
.theme-kids .pa{border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,.1);}
.pl{font-family:var(--font-pixel);font-size:10px;color:var(--accent3);}.pn{font-size:14px;font-weight:800;}
.xps{text-align:right;}.xpl{font-family:var(--font-pixel);font-size:8px;color:var(--accent4);margin-bottom:4px;}
.xpbg{width:100px;height:10px;background:rgba(128,128,128,.2);border-radius:5px;overflow:hidden;}
.xpf{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--accent4),var(--gold));transition:width .5s;box-shadow:0 0 8px rgba(255,230,0,.4);}
.stb{display:flex;align-items:center;gap:4px;justify-content:flex-end;font-family:var(--font-pixel);font-size:9px;color:var(--accent2);margin-top:3px;}
.tbc{padding:16px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:var(--radius);margin-bottom:14px;box-shadow:var(--card-shadow);position:relative;overflow:hidden;}
.tbc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent3),var(--accent4));}
.tbh{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.tbt{font-family:var(--font-display);font-size:12px;font-weight:900;color:var(--accent3);display:flex;align-items:center;gap:6px;}
.tbb{font-family:var(--font-pixel);font-size:28px;color:var(--text-main);text-align:center;margin:6px 0 4px;text-shadow:0 0 16px rgba(57,255,20,.3);letter-spacing:2px;}
.theme-kids .tbb{text-shadow:none;color:var(--accent1);}
.tbs{text-align:center;font-size:11px;color:var(--text-dim);margin-bottom:12px;}
.tba{display:flex;gap:8px;}
.tbn{flex:1;padding:10px;border:none;border-radius:10px;font-family:var(--font-body);font-size:13px;font-weight:800;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;}
.tbn:active{transform:scale(.96);}
.tbd{background:linear-gradient(135deg,rgba(57,255,20,.15),rgba(57,255,20,.08));color:var(--accent3);border:1.5px solid rgba(57,255,20,.3);}
.tbw{background:linear-gradient(135deg,rgba(255,45,149,.12),rgba(255,68,68,.08));color:var(--accent2);border:1.5px solid rgba(255,45,149,.3);}
.theme-kids .tbd{background:var(--accent3);color:#fff;border:none;}
.theme-kids .tbw{background:var(--accent2);color:#fff;border:none;}
.nav-tabs{display:flex;gap:2px;background:var(--bg-card);border-radius:var(--radius);padding:4px;margin-bottom:14px;border:1px solid rgba(128,128,128,.1);box-shadow:var(--card-shadow);}
.nav-tab{flex:1;padding:8px 2px;border:none;background:transparent;color:var(--text-dim);font-family:var(--font-body);font-size:9px;font-weight:800;border-radius:10px;cursor:pointer;transition:all .3s;display:flex;flex-direction:column;align-items:center;gap:2px;}
.nav-tab .ti{font-size:16px;}.nav-tab.active{background:linear-gradient(135deg,rgba(0,212,255,.15),rgba(178,77,255,.1));color:var(--accent1);box-shadow:0 0 10px rgba(0,212,255,.1);}
.theme-kids .nav-tab.active{background:rgba(77,200,255,.12);box-shadow:none;}
.tc{display:none;}.tc.active{display:block;animation:tabIn .3s ease;}
@keyframes tabIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.st{font-family:var(--font-pixel);font-size:11px;color:var(--accent1);margin-bottom:12px;text-shadow:0 0 10px rgba(0,212,255,.3);display:flex;align-items:center;gap:8px;}
.theme-kids .st{font-family:var(--font-display);font-size:16px;font-weight:900;text-shadow:none;}
.qir{display:flex;gap:8px;margin-bottom:14px;}
.qi{flex:1;padding:12px 14px;background:var(--bg-card);border:1.5px solid var(--border-glow);border-radius:12px;color:var(--text-main);font-family:var(--font-body);font-size:14px;outline:none;transition:border-color .3s,box-shadow .3s;}
.qi:focus{border-color:var(--accent1);box-shadow:0 0 12px rgba(0,212,255,.15);}
.qi::placeholder{color:var(--text-dim);}
.btn{padding:10px 16px;border:none;border-radius:12px;font-family:var(--font-body);font-weight:800;font-size:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;}
.btn:active{transform:scale(.96);}
.btn-p{background:linear-gradient(135deg,var(--accent1),var(--accent5));color:#fff;box-shadow:0 0 14px rgba(0,212,255,.25);}
.theme-kids .btn-p{background:var(--accent1);box-shadow:0 4px 12px rgba(77,200,255,.3);}
.ql{display:flex;flex-direction:column;gap:8px;}
.qc{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-card);border:1px solid rgba(128,128,128,.08);border-radius:var(--radius);transition:all .3s;position:relative;overflow:hidden;box-shadow:var(--card-shadow);}
.qc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent1);opacity:.5;}
.qc.done{opacity:.5;}.qc.done::before{background:var(--accent3);opacity:1;}
.qk{width:30px;height:30px;border:2px solid var(--text-dim);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .3s;font-size:14px;background:transparent;color:transparent;}
.theme-kids .qk{border-radius:50%;}
.qc.done .qk{border-color:var(--accent3);background:rgba(57,255,20,.15);color:var(--accent3);}
.qt{flex:1;font-size:14px;line-height:1.4;}.qc.done .qt{text-decoration:line-through;color:var(--text-dim);}
.qx{font-family:var(--font-pixel);font-size:8px;color:var(--accent4);white-space:nowrap;}
.qd{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:4px;border-radius:4px;transition:color .2s;}.qd:hover{color:var(--danger);}
.qed{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:4px;border-radius:4px;transition:color .2s;}.qed:hover{color:var(--accent1);}
.q-repeat{font-size:10px;color:var(--accent5);margin-left:4px;}
.q-actions{display:flex;gap:2px;align-items:center;flex-shrink:0;}
.q-edit-input{flex:1;padding:6px 10px;background:var(--bg-card2);border:1.5px solid var(--accent1);border-radius:8px;color:var(--text-main);font-family:var(--font-body);font-size:14px;outline:none;}
.day-btn{width:32px;height:32px;border:1.5px solid rgba(128,128,128,.2);border-radius:8px;background:transparent;color:var(--text-dim);font-size:11px;font-weight:800;font-family:var(--font-body);cursor:pointer;transition:all .2s;}
.day-btn.sel{border-color:var(--accent5);color:var(--accent5);background:rgba(178,77,255,.1);}
.q-days-mini{font-size:9px;color:var(--accent5);margin-left:4px;}
.q-filters{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;}
.q-fil{padding:5px 12px;border:1.5px solid rgba(128,128,128,.15);border-radius:20px;background:transparent;color:var(--text-dim);font-family:var(--font-body);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;}
.q-fil.active{border-color:var(--accent1);color:var(--accent1);background:rgba(0,212,255,.08);}
.q-cat{font-size:10px;margin-left:4px;padding:1px 6px;border-radius:8px;font-weight:700;}
.q-cat-health{background:rgba(255,107,157,.12);color:var(--accent2);}
.q-cat-study{background:rgba(0,212,255,.12);color:var(--accent1);}
.qe{text-align:center;padding:40px 20px;color:var(--text-dim);font-size:14px;}.qe .ei{font-size:44px;margin-bottom:12px;display:block;}

/* Timer */
.td{text-align:center;padding:24px 20px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:var(--radius);margin-bottom:14px;position:relative;overflow:hidden;box-shadow:var(--card-shadow);}
.tml{font-family:var(--font-pixel);font-size:10px;color:var(--accent3);margin-bottom:10px;letter-spacing:2px;}.tml.bm{color:var(--accent2);}
.trw{position:relative;width:220px;height:220px;margin:0 auto 12px;}
.trs{width:100%;height:100%;transform:rotate(-90deg);}
.trb{fill:none;stroke:rgba(128,128,128,.12);stroke-width:8;}
.trp{fill:none;stroke:var(--accent1);stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset .8s linear,stroke .5s;filter:drop-shadow(0 0 6px rgba(0,212,255,.5));}
.trp.urgent{stroke:var(--danger);filter:drop-shadow(0 0 10px rgba(255,68,68,.7));animation:rp 1s ease-in-out infinite;}
.trp.br{stroke:var(--accent2);filter:drop-shadow(0 0 6px rgba(255,45,149,.5));}
.theme-kids .trp{filter:none;}.theme-kids .trp.urgent{filter:none;}
@keyframes rp{0%,100%{opacity:1}50%{opacity:.5}}
.tcn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;width:180px;}
.tt{font-family:var(--font-display);font-size:44px;font-weight:900;color:var(--text-main);text-shadow:0 0 20px rgba(0,212,255,.4);letter-spacing:2px;line-height:1;}
.theme-kids .tt{text-shadow:none;color:var(--accent1);}
.tt.urgent{color:var(--danger)!important;text-shadow:0 0 20px rgba(255,68,68,.5);animation:pul 1s ease-in-out infinite;}
@keyframes pul{0%,100%{opacity:1}50%{opacity:.6}}
.tdl{font-size:12px;font-weight:800;color:var(--accent4);margin-top:6px;min-height:18px;transition:all .3s;}
.tdl.ut{color:var(--danger);animation:pul 1s ease-in-out infinite;font-size:13px;}.tdl.hid{opacity:0;}
.sds{display:flex;gap:8px;justify-content:center;margin:10px 0 16px;}
.sd{width:12px;height:12px;border-radius:50%;border:2px solid var(--text-dim);transition:all .3s;}
.sd.dn{background:var(--accent3);border-color:var(--accent3);box-shadow:0 0 6px rgba(57,255,20,.5);}
.sd.cur{border-color:var(--accent1);box-shadow:0 0 6px rgba(0,212,255,.5);animation:pul 2s ease-in-out infinite;}
.tcs{display:flex;gap:12px;justify-content:center;}
.bt{width:56px;height:56px;border-radius:50%;border:none;font-size:22px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;}
.bt:active{transform:scale(.92);}
.bts{background:linear-gradient(135deg,var(--accent3),#00cc44);color:#000;box-shadow:0 0 16px rgba(57,255,20,.3);}
.btp{background:linear-gradient(135deg,var(--accent4),#ccaa00);color:#000;box-shadow:0 0 16px rgba(255,230,0,.3);}
.btr{background:rgba(128,128,128,.15);color:var(--text-dim);}
.tps{display:flex;gap:6px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
.tp{padding:7px 14px;background:rgba(128,128,128,.08);border:1px solid rgba(128,128,128,.15);border-radius:20px;color:var(--text-dim);font-size:12px;font-family:var(--font-body);cursor:pointer;transition:all .2s;font-weight:700;}
.tp:hover,.tp.active{border-color:var(--accent1);color:var(--accent1);background:rgba(0,212,255,.08);}

/* Shield */
.sc{text-align:center;padding:28px 20px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:var(--radius);margin-bottom:14px;box-shadow:var(--card-shadow);}
.si{font-size:60px;margin-bottom:10px;display:block;animation:fl 3s ease-in-out infinite;}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.sm{font-size:16px;font-weight:800;line-height:1.6;margin-bottom:6px;}.ss{font-size:13px;color:var(--text-dim);margin-bottom:18px;}
.tmb{width:100%;padding:16px;background:linear-gradient(135deg,rgba(255,45,149,.12),rgba(255,68,68,.08));border:2px solid var(--accent2);border-radius:var(--radius);color:var(--accent2);font-family:var(--font-body);font-size:16px;font-weight:800;cursor:pointer;transition:all .3s;margin-bottom:14px;}
.tmb:active{transform:scale(.97);}
.theme-kids .tmb{background:var(--accent2);color:#fff;border:none;border-radius:999px;}
.rs{display:flex;gap:12px;justify-content:center;}
.rsi{padding:10px 18px;background:rgba(57,255,20,.06);border:1px solid rgba(57,255,20,.15);border-radius:12px;text-align:center;}
.theme-kids .rsi{background:rgba(93,214,98,.1);border-color:rgba(93,214,98,.2);}
.rsn{font-family:var(--font-pixel);font-size:20px;color:var(--accent3);display:block;}
.rsl{font-size:11px;color:var(--text-dim);margin-top:4px;}

/* ===== SCHEDULE TAB ===== */
.sched-add{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.sched-time-input{width:90px;padding:10px;background:var(--bg-card);border:1.5px solid var(--border-glow);border-radius:10px;color:var(--text-main);font-family:var(--font-body);font-size:15px;font-weight:700;outline:none;text-align:center;transition:border-color .3s;}
.sched-time-input:focus{border-color:var(--accent1);}
.sched-text-input{flex:1;min-width:120px;padding:10px 12px;background:var(--bg-card);border:1.5px solid var(--border-glow);border-radius:10px;color:var(--text-main);font-family:var(--font-body);font-size:14px;outline:none;transition:border-color .3s;}
.sched-text-input:focus{border-color:var(--accent1);}
.sched-text-input::placeholder{color:var(--text-dim);}

.timeline{position:relative;padding-left:28px;}
.timeline::before{content:'';position:absolute;left:11px;top:0;bottom:0;width:2px;background:rgba(128,128,128,.15);}
.tl-item{position:relative;margin-bottom:10px;animation:tabIn .3s ease;}
.tl-dot{position:absolute;left:-28px;top:14px;width:12px;height:12px;border-radius:50%;border:2px solid var(--text-dim);background:var(--bg-dark);z-index:2;transition:all .3s;}
.tl-item.past .tl-dot{background:var(--text-dim);border-color:var(--text-dim);}
.tl-item.current .tl-dot{background:var(--accent1);border-color:var(--accent1);box-shadow:0 0 8px rgba(0,212,255,.5);animation:pul 2s ease-in-out infinite;}
.tl-item.done .tl-dot{background:var(--accent3);border-color:var(--accent3);box-shadow:0 0 8px rgba(57,255,20,.4);}
.tl-item.missed .tl-dot{background:var(--danger);border-color:var(--danger);}

.tl-card{padding:12px 14px;background:var(--bg-card);border:1px solid rgba(128,128,128,.08);border-radius:var(--radius);box-shadow:var(--card-shadow);display:flex;align-items:center;gap:10px;transition:all .3s;}
.tl-item.current .tl-card{border-color:var(--accent1);box-shadow:0 0 12px rgba(0,212,255,.15);}
.tl-item.done .tl-card{opacity:.6;border-color:rgba(57,255,20,.2);}
.tl-item.missed .tl-card{opacity:.5;border-color:rgba(255,68,68,.2);}

.tl-time{font-family:var(--font-pixel);font-size:10px;color:var(--accent1);white-space:nowrap;min-width:44px;}
.tl-item.done .tl-time{color:var(--accent3);}
.tl-item.missed .tl-time{color:var(--danger);}
.tl-info{flex:1;}
.tl-name{font-size:14px;font-weight:700;}
.tl-item.done .tl-name{text-decoration:line-through;color:var(--text-dim);}
.tl-status{font-size:10px;color:var(--text-dim);margin-top:2px;}

.tl-actions{display:flex;gap:4px;align-items:center;}
.tl-check{width:28px;height:28px;border:2px solid var(--text-dim);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;background:transparent;color:transparent;font-size:13px;transition:all .3s;flex-shrink:0;}
.theme-kids .tl-check{border-radius:50%;}
.tl-item.done .tl-check{border-color:var(--accent3);background:rgba(57,255,20,.15);color:var(--accent3);}
.tl-del{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;padding:2px;transition:color .2s;}.tl-del:hover{color:var(--danger);}

.sched-empty{text-align:center;padding:30px 20px;color:var(--text-dim);font-size:14px;}
.sched-empty .sei{font-size:40px;margin-bottom:10px;display:block;}

.sched-summary{display:flex;gap:8px;margin-bottom:14px;}
.sched-sum-card{flex:1;padding:10px;background:var(--bg-card);border:1px solid rgba(128,128,128,.06);border-radius:var(--radius);text-align:center;box-shadow:var(--card-shadow);}
.sched-sum-num{font-family:var(--font-pixel);font-size:16px;margin-bottom:4px;}
.sched-sum-label{font-size:10px;color:var(--text-dim);}
.ssn1{color:var(--accent1);}.ssn2{color:var(--accent3);}.ssn3{color:var(--danger);}

.notif-banner{display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);max-width:440px;width:calc(100% - 32px);padding:14px 18px;background:var(--bg-card);border:2px solid var(--accent1);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:5000;animation:notifIn .4s cubic-bezier(.34,1.56,.64,1);align-items:center;gap:10px;}
.notif-banner.show{display:flex;}
@keyframes notifIn{from{transform:translateX(-50%) translateY(100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
.notif-icon{font-size:28px;flex-shrink:0;}
.notif-body{flex:1;}
.notif-title{font-family:var(--font-pixel);font-size:9px;color:var(--accent1);margin-bottom:2px;}
.notif-text{font-size:13px;font-weight:700;}
.notif-close{background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;}

/* Stats */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.skc{padding:16px;background:var(--bg-card);border:1px solid rgba(128,128,128,.06);border-radius:var(--radius);text-align:center;box-shadow:var(--card-shadow);}
.sv{font-family:var(--font-pixel);font-size:20px;margin-bottom:6px;}.sl{font-size:11px;color:var(--text-dim);}
.skc:nth-child(1) .sv{color:var(--accent1);}.skc:nth-child(2) .sv{color:var(--accent3);}.skc:nth-child(3) .sv{color:var(--accent4);}.skc:nth-child(4) .sv{color:var(--accent2);}
.tlg{margin-top:14px;padding:16px;background:var(--bg-card);border:1px solid rgba(128,128,128,.06);border-radius:var(--radius);box-shadow:var(--card-shadow);}
.lgt{font-size:13px;font-weight:800;margin-bottom:10px;color:var(--accent1);}
.lr{display:flex;align-items:center;gap:8px;margin-bottom:6px;}.ll{font-size:11px;color:var(--text-dim);width:50px;text-align:right;}
.ltk{flex:1;height:12px;background:rgba(128,128,128,.1);border-radius:6px;overflow:hidden;}.lf{height:100%;border-radius:6px;transition:width .5s;}
.lv{font-family:var(--font-pixel);font-size:8px;width:44px;color:var(--text-dim);}
.ach{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg-card);border:1px solid rgba(128,128,128,.06);border-radius:var(--radius);margin-bottom:8px;box-shadow:var(--card-shadow);transition:all .3s;}
.ach.ul{border-color:rgba(255,215,0,.25);}.ach.lk{opacity:.35;}
.ai{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.ach.ul .ai{background:rgba(255,215,0,.12);}.ach.lk .ai{background:rgba(128,128,128,.08);filter:grayscale(1);}
.af{flex:1;}.an{font-size:13px;font-weight:800;margin-bottom:2px;}.ad{font-size:11px;color:var(--text-dim);}
.btn-d{background:rgba(255,68,68,.1);color:var(--danger);border:1px solid rgba(255,68,68,.2);width:100%;justify-content:center;margin-top:18px;}

/* Modals */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center;padding:20px;}.mo.show{display:flex;}
.mc{background:var(--bg-card);border:2px solid var(--accent2);border-radius:20px;padding:28px 22px;max-width:380px;width:100%;text-align:center;box-shadow:0 0 40px rgba(255,45,149,.25);animation:mp .4s cubic-bezier(.34,1.56,.64,1);}
.theme-kids .mc{border-radius:28px;box-shadow:0 8px 32px rgba(0,0,0,.15);}
@keyframes mp{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
.mci{font-size:52px;margin-bottom:10px;display:block;}.mct{font-family:var(--font-pixel);font-size:13px;color:var(--accent2);margin-bottom:14px;}
.mcq{font-size:15px;line-height:1.7;margin-bottom:6px;font-style:italic;}.mca{font-size:12px;color:var(--text-dim);margin-bottom:16px;}
.mcd{font-family:var(--font-display);font-size:40px;font-weight:900;color:var(--accent4);margin:12px 0;text-shadow:0 0 16px rgba(255,230,0,.4);}
.mcdl{font-size:12px;color:var(--text-dim);margin-bottom:16px;}
.mbs{display:flex;gap:10px;}.mbs .btn{flex:1;justify-content:center;padding:12px;}
.btn-r{background:linear-gradient(135deg,var(--accent3),#00cc44);color:#000;box-shadow:0 0 12px rgba(57,255,20,.25);}
.btn-g{background:rgba(255,68,68,.12);color:var(--danger);border:1px solid rgba(255,68,68,.3);}
.tbmc{border-color:var(--accent3);box-shadow:0 0 40px rgba(57,255,20,.2);}.tbmc.wm{border-color:var(--accent2);box-shadow:0 0 40px rgba(255,45,149,.2);}
.tbad{font-family:var(--font-display);font-size:36px;font-weight:900;color:var(--accent3);margin:12px 0;}.tbmc.wm .tbad{color:var(--accent2);}
.tbabs{display:flex;gap:6px;justify-content:center;margin-bottom:16px;flex-wrap:wrap;}
.tbab{padding:8px 14px;background:rgba(128,128,128,.1);border:1px solid rgba(128,128,128,.15);border-radius:20px;color:var(--text-dim);font-family:var(--font-body);font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}.tbab:hover{border-color:var(--accent1);color:var(--accent1);}
.celo{display:none;position:fixed;inset:0;z-index:2000;pointer-events:none;}.celo.show{display:block;}
.cm{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2001;justify-content:center;align-items:center;}.cm.show{display:flex;}
.cmco{text-align:center;animation:ci .6s cubic-bezier(.34,1.56,.64,1);}
@keyframes ci{from{transform:scale(.5) rotate(-10deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.cmci{font-size:100px;animation:cb 1s ease-in-out infinite;}
@keyframes cb{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-15px) scale(1.1)}}
.cmct{font-family:var(--font-display);font-size:24px;font-weight:900;margin:16px 0 8px;}
.cmcx{font-family:var(--font-pixel);font-size:18px;color:var(--accent4);text-shadow:0 0 16px rgba(255,230,0,.6);margin-bottom:8px;}
.cmcb{font-size:14px;color:var(--accent3);margin-bottom:16px;}
.cmcn{padding:14px 40px;background:linear-gradient(135deg,var(--accent1),var(--accent5));color:#fff;border:none;border-radius:12px;font-family:var(--font-body);font-size:16px;font-weight:800;cursor:pointer;box-shadow:0 0 20px rgba(0,212,255,.4);pointer-events:auto;}.cmcn:active{transform:scale(.95);}
.xpp{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--font-pixel);font-size:24px;color:var(--accent4);text-shadow:0 0 20px rgba(255,230,0,.8);pointer-events:none;z-index:999;animation:xp 1.2s ease-out forwards;}
@keyframes xp{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.3)}40%{transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-80%)}}
.luo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;justify-content:center;align-items:center;}.luo.show{display:flex;}
.luc{text-align:center;animation:mp .5s cubic-bezier(.34,1.56,.64,1);}
.lui{font-size:80px;margin-bottom:12px;}.lut{font-family:var(--font-display);font-size:22px;font-weight:900;color:var(--gold);text-shadow:0 0 30px rgba(255,215,0,.8);margin-bottom:8px;}
.lul{font-family:var(--font-display);font-size:44px;font-weight:900;color:var(--accent1);text-shadow:0 0 30px rgba(0,212,255,.8);}
.pwa-b{display:none;padding:12px 16px;background:var(--bg-card2);border:1px solid var(--border-glow);border-radius:var(--radius);margin-bottom:12px;font-size:13px;align-items:center;gap:8px;box-shadow:var(--card-shadow);}
.pwa-b.show{display:flex;}.pwa-bt{flex:1;}.pwa-bc{background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;}
.help-btn{width:34px;height:34px;border-radius:50%;border:1.5px solid var(--border-glow);background:var(--bg-card);color:var(--accent1);font-size:16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;}.help-btn:active{transform:scale(.92);}
.help-body{text-align:left;max-height:60vh;overflow-y:auto;padding-right:4px;}
.help-body::-webkit-scrollbar{width:4px;}.help-body::-webkit-scrollbar-thumb{background:var(--text-dim);border-radius:2px;}
.help-section{margin-bottom:16px;}
.help-h{font-family:var(--font-display);font-size:13px;font-weight:900;color:var(--accent1);margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.help-p{font-size:13px;line-height:1.7;color:var(--text-main);}
.help-p b{color:var(--accent4);}
.help-table{width:100%;font-size:12px;border-collapse:collapse;margin:6px 0;}
.help-table td{padding:4px 8px;border-bottom:1px solid rgba(128,128,128,.1);}
.help-table td:first-child{color:var(--accent4);white-space:nowrap;font-weight:700;}
@keyframes confettiFall{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(100vh) rotate(720deg)}}
@media(max-width:360px){.trw{width:180px;height:180px;}.tt{font-size:36px;}.sg{grid-template-columns:1fr;}.tbb{font-size:24px;}}
</style>
</head>
<body>
<div class="app" id="app">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;"><div style="font-family:var(--font-display);font-size:14px;font-weight:900;color:var(--accent1);">âš”ï¸ Focus Quest</div><button class="help-btn" onclick="document.getElementById('helpModal').classList.add('show')">â“</button></div>
  <div class="user-switcher" id="userSwitcher"></div>
  <div class="mode-switcher"><label id="lA" class="active-label">ğŸ—¡ï¸ ãŠã¨ãª</label><div class="switch-track" id="msTrack"><div class="switch-thumb"></div></div><label id="lK">ğŸŒˆ ã“ã©ã‚‚</label></div>
  <div class="profile-bar" id="profBar"></div>
  <div class="status-bar"><div class="pi"><div class="pa" id="pAvatar">âš”ï¸</div><div><div class="pl" id="pLevel">Lv.1</div><div class="pn" id="pName">å†’é™ºè€…</div></div></div><div class="xps"><div class="xpl">EXP</div><div class="xpbg"><div class="xpf" id="xpBar" style="width:0%"></div></div><div class="stb">ğŸ”¥ <span id="strk">0</span> æ—¥é€£ç¶š</div></div></div>
  <div class="tbc"><div class="tbh"><div class="tbt">ğŸ¦ <span id="tbTT">ã‚¿ã‚¤ãƒ ãƒãƒ³ã‚¯</span></div></div><div class="tbb" id="tbBal">00:00</div><div class="tbs" id="tbSub">é›†ä¸­ã—ãŸæ™‚é–“ã‚’è²¯é‡‘ã—ã¦ã€è‡ªç”±æ™‚é–“ã«å¤‰æ›ã—ã‚ˆã†</div><div class="tba"><button class="tbn tbd" id="tbDep">ï¼‹ ãŸã‚ã‚‹</button><button class="tbn tbw" id="tbWith">ï¼ ã¤ã‹ã†</button></div></div>
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="quests"><span class="ti">âš”ï¸</span>ã‚¯ã‚¨ã‚¹ãƒˆ</button>
    <button class="nav-tab" data-tab="timer"><span class="ti">â±ï¸</span>ã‚¿ã‚¤ãƒãƒ¼</button>
    <button class="nav-tab" data-tab="shield"><span class="ti">ğŸ›¡ï¸</span>ã‚·ãƒ¼ãƒ«ãƒ‰</button>
    <button class="nav-tab" data-tab="stats"><span class="ti">ğŸ“Š</span>ãã‚ã</button>
  </div>

  <div class="tc active" id="tab-quests"><div class="st">ğŸ“œ ä»Šæ—¥ã®ã‚¯ã‚¨ã‚¹ãƒˆ</div><div class="qir"><input type="text" class="qi" id="qInp" placeholder="ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ ..." maxlength="100"><button class="btn btn-p" id="addQ">+è¿½åŠ </button></div><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;"><label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-dim);cursor:pointer;"><span>âš¡EXP:</span><input type="number" id="qExpInp" value="15" min="1" max="999" style="width:50px;padding:4px 6px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:8px;color:var(--text-main);font-family:var(--font-pixel);font-size:10px;text-align:center;outline:none;"></label><select id="qCatInp" style="padding:5px 8px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:8px;color:var(--text-main);font-family:var(--font-body);font-size:12px;outline:none;"><option value="">âš”ï¸ é€šå¸¸</option><option value="health">ğŸ¥ å¥åº·</option><option value="study">ğŸ“š å‹‰å¼·</option></select><label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-dim);cursor:pointer;"><input type="checkbox" id="qRepeat" style="accent-color:var(--accent5);width:16px;height:16px;" onchange="document.getElementById('qDaysRow').style.display=this.checked?'flex':'none'"> <span id="qRepeatLabel">ğŸ” ãã‚Šã‹ãˆã—</span></label></div><div id="qDaysRow" style="display:none;gap:4px;margin-bottom:14px;flex-wrap:wrap;"></div><div class="q-filters" id="qFilters"></div><div class="ql" id="qList"></div></div>

  <div class="tc" id="tab-timer"><div class="st">â±ï¸ çŸ­æ™‚é–“é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼</div><div class="td"><div class="tml" id="tmLabel">âš”ï¸ FOCUS MODE</div><div class="trw"><svg class="trs" viewBox="0 0 240 240"><circle class="trb" cx="120" cy="120" r="105"/><circle class="trp" id="tmRing" cx="120" cy="120" r="105" stroke-dasharray="659.73" stroke-dashoffset="0"/></svg><div class="tcn"><div class="tt" id="tmTime">15:00</div><div class="tdl hid" id="tmDead"></div></div></div><div class="sds" id="sDots"></div><div class="tcs"><button class="bt btr" id="tmRst">â†º</button><button class="bt bts" id="tmStr">â–¶</button></div></div><div class="tps"><button class="tp active" data-minutes="15">15åˆ†</button><button class="tp" data-minutes="10">10åˆ†</button><button class="tp" data-minutes="20">20åˆ†</button><button class="tp" data-minutes="25">25åˆ†</button><button class="tp" data-minutes="5" data-break="true">ä¼‘æ†©5åˆ†</button></div></div>

  <div class="tc" id="tab-shield"><div class="st">ğŸ›¡ï¸ èª˜æƒ‘ã‚·ãƒ¼ãƒ«ãƒ‰</div><div class="sc"><span class="si" id="shE">ğŸ›¡ï¸</span><div class="sm" id="shM">èª˜æƒ‘ã«è² ã‘ãã†ã«ãªã£ãŸã‚‰<br>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ï¼</div><div class="ss" id="shS">YouTubeã‚„SNSã‚’è¦‹ãŸããªã£ãŸã‚‰æŠ¼ã—ã¦ã­</div><button class="tmb" id="tmpBtn">ğŸ˜ˆ èª˜æƒ‘ãŒæ¥ãŸï¼åŠ©ã‘ã¦ï¼</button><div class="rs"><div class="rsi"><span class="rsn" id="resC">0</span><div class="rsl">æ’ƒé€€å›æ•°</div></div><div class="rsi"><span class="rsn" id="resS">0</span><div class="rsl">é€£ç¶šæ’ƒé€€</div></div></div></div></div>

  <div class="tc" id="tab-stats"><div class="st">ğŸ“Š å†’é™ºã®è¨˜éŒ²</div><div class="sg"><div class="skc"><div class="sv" id="stF">0</div><div class="sl">é›†ä¸­ã—ãŸæ™‚é–“(åˆ†)</div></div><div class="skc"><div class="sv" id="stQ">0</div><div class="sl">å®Œäº†ã‚¯ã‚¨ã‚¹ãƒˆ</div></div><div class="skc"><div class="sv" id="stX">0</div><div class="sl">ç²å¾—EXP</div></div><div class="skc"><div class="sv" id="stR">0</div><div class="sl">èª˜æƒ‘æ’ƒé€€</div></div></div><div class="tlg"><div class="lgt">ğŸ“… ä»Šæ—¥ã®æ´»å‹•</div><div class="lr"><div class="ll">é›†ä¸­</div><div class="ltk"><div class="lf" id="lgFB" style="width:0%;background:var(--accent1)"></div></div><div class="lv" id="lgFV">0åˆ†</div></div><div class="lr"><div class="ll">ã‚¯ã‚¨ã‚¹ãƒˆ</div><div class="ltk"><div class="lf" id="lgQB" style="width:0%;background:var(--accent3)"></div></div><div class="lv" id="lgQV">0/0</div></div><div class="lr"><div class="ll">æ’ƒé€€</div><div class="ltk"><div class="lf" id="lgRB" style="width:0%;background:var(--accent2)"></div></div><div class="lv" id="lgRV">0å›</div></div></div><div id="achList" style="margin-top:14px"></div><button class="btn btn-d" id="rstBtn">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button></div>
</div>

<!-- Temptation Modal -->
<div class="mo" id="tmpModal"><div class="mc"><span class="mci">âš ï¸</span><div class="mct" id="tmT">èª˜æƒ‘ã‚¢ãƒ©ãƒ¼ãƒˆï¼</div><div class="mcq" id="tmQ"></div><div class="mca" id="tmA"></div><div class="mcd" id="tmCD">10</div><div class="mcdl" id="tmCDL">å†·å´ã‚¿ã‚¤ãƒ ...æ·±å‘¼å¸ã—ã¦</div><div class="mbs"><button class="btn btn-r" id="resBtn">ğŸ’ª è€ãˆãŸï¼</button><button class="btn btn-g" id="gavBtn">ğŸ˜” è² ã‘ãŸâ€¦</button></div></div></div>
<!-- TB Modal -->
<div class="mo" id="tbMod"><div class="mc tbmc" id="tbMC"><span class="mci" id="tbMI">ğŸ¦</span><div class="mct" id="tbMT">æ™‚é–“ã‚’ãŸã‚ã‚‹</div><div class="tbad" id="tbAD">00:00</div><div class="tbabs"><button class="tbab" data-min="5">+5åˆ†</button><button class="tbab" data-min="10">+10åˆ†</button><button class="tbab" data-min="15">+15åˆ†</button><button class="tbab" data-min="30">+30åˆ†</button><button class="tbab" data-min="60">+60åˆ†</button></div><div class="mbs"><button class="btn btn-p" id="tbOK">OK</button><button class="btn btn-g" id="tbCan">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div></div>
<!-- Celebration -->
<div class="celo" id="celO"></div>
<div class="cm" id="compM"><div class="cmco"><div class="cmci" id="compI">ğŸ‰</div><div class="cmct" id="compT" style="color:var(--gold)">MISSION COMPLETE!</div><div class="cmcx" id="compX">+25 EXP</div><div class="cmcb" id="compB">â° ã‚¿ã‚¤ãƒ ãƒãƒ³ã‚¯ã«15åˆ†è²¯é‡‘ï¼</div><button class="cmcn" id="compBtn">OKï¼</button></div></div>
<!-- Level Up -->
<div class="luo" id="luO"><div class="luc"><div class="lui">â­</div><div class="lut">LEVEL UP!</div><div class="lul" id="luL">Lv.2</div></div></div>
<!-- Notification Banner -->
<div class="notif-banner" id="notifBanner"><div class="notif-icon" id="notifIcon">ğŸ””</div><div class="notif-body"><div class="notif-title" id="notifTitle">ãƒªãƒã‚¤ãƒ³ãƒ‰</div><div class="notif-text" id="notifText"></div></div><button class="notif-close" id="notifClose">âœ•</button></div>

<!-- Help Modal -->
<div class="mo" id="helpModal"><div class="mc" style="border-color:var(--accent1);box-shadow:0 0 40px rgba(0,212,255,.2);max-width:420px;"><span class="mci">ğŸ“–</span><div class="mct" style="color:var(--accent1);">ã¤ã‹ã„ã‹ãŸ</div><div class="help-modal-body">
<div class="help-section"><div class="help-section-title">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆ</div><p>ç”»é¢ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³ã§<span class="help-highlight">æœ€å¤§3äºº</span>ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚âš™ï¸ãƒœã‚¿ãƒ³ã§åå‰ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒ¬ãƒ™ãƒ«/EXPã‚’ç·¨é›†ã§ãã¾ã™ã€‚å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«ç‹¬ç«‹ã—ã¦ã„ã¾ã™ã€‚</p></div>
<div class="help-section"><div class="help-section-title">ğŸ—¡ï¸/ğŸŒˆ ãŠã¨ãª/ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰</div><p>è¦‹ãŸç›®ã¨è¨€è‘‰é£ã„ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚ãŠã¨ãªãƒ¢ãƒ¼ãƒ‰ã¯ã‚µã‚¤ãƒãƒ¼RPGé¢¨ã€ã“ã©ã‚‚ãƒ¢ãƒ¼ãƒ‰ã¯ã‚«ãƒ©ãƒ•ãƒ«ã§ã‚„ã•ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã™ã€‚å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é¸ã¹ã¾ã™ã€‚</p></div>
<div class="help-section"><div class="help-section-title">âš”ï¸ ã‚¯ã‚¨ã‚¹ãƒˆ</div><p>ä»Šæ—¥ã‚„ã‚‹ã“ã¨ã‚’ç™»éŒ²ã—ã¦ã€å®Œäº†ã—ãŸã‚‰ãƒã‚§ãƒƒã‚¯ï¼<span class="help-highlight">1ã¤å®Œäº†ã”ã¨ã«EXPç²å¾—</span>ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ+15ã€å€‹åˆ¥ã«å¤‰æ›´å¯ï¼‰ã€‚å…¨éƒ¨å®Œäº†ã™ã‚‹ã¨<span class="help-highlight">+50 EXPãƒœãƒ¼ãƒŠã‚¹</span>ï¼ˆ1æ—¥1å›ï¼‰ã€‚</p><p>âœï¸ã§ç·¨é›†ã€ğŸ”ã§æ¯æ—¥/æ›œæ—¥ã”ã¨ã®ç¹°ã‚Šè¿”ã—è¨­å®šãŒã§ãã¾ã™ã€‚ã‚«ãƒ†ã‚´ãƒªï¼ˆâš”ï¸é€šå¸¸/ğŸ¥å¥åº·/ğŸ“šå‹‰å¼·ï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚å¯èƒ½ã€‚</p></div>
<div class="help-section"><div class="help-section-title">â±ï¸ é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼</div><p><span class="help-highlight">çŸ­æ™‚é–“åˆ»ã¿å‹‰å¼·æ³•</span>ã«å¯¾å¿œã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ15åˆ†ã§é›†ä¸­â†’5åˆ†ä¼‘æ†©ã‚’4ã‚»ãƒƒãƒˆã€‚æ®‹ã‚Šæ™‚é–“ãŒæ¸›ã‚‹å††å½¢ãƒªãƒ³ã‚°ã¨ã€Œ<span class="help-highlight">ç· ã‚åˆ‡ã‚Šã¾ã§ã‚ã¨â—‹åˆ†ï¼</span>ã€ã®è¡¨ç¤ºã§ç·Šè¿«æ„ŸUPã€‚å®Œäº†ã™ã‚‹ã¨<span class="help-highlight">+25 EXP</span>ï¼‹ã‚¿ã‚¤ãƒ ãƒãƒ³ã‚¯ã«è‡ªå‹•è²¯é‡‘ã€‚</p></div>
<div class="help-section"><div class="help-section-title">ğŸ›¡ï¸ èª˜æƒ‘ã‚·ãƒ¼ãƒ«ãƒ‰</div><p>YouTubeã‚„SNSã‚’è¦‹ãŸããªã£ãŸã‚‰ã‚¿ãƒƒãƒ—ï¼10ç§’ã®å†·å´ã‚¿ã‚¤ãƒ ã¨åè¨€ã§æ°—æŒã¡ã‚’ãƒªã‚»ãƒƒãƒˆã€‚è€ãˆãŸã‚‰<span class="help-highlight">+20 EXP</span>ã€‚</p></div>
<div class="help-section"><div class="help-section-title">ğŸ¦ ã‚¿ã‚¤ãƒ ãƒãƒ³ã‚¯</div><p>é›†ä¸­ã—ãŸæ™‚é–“ãŒè‡ªå‹•ã§è²¯é‡‘ã•ã‚Œã¾ã™ã€‚è²¯ã‚ãŸæ™‚é–“ã¯ã€Œè‡ªç”±æ™‚é–“ã€ã¨ã—ã¦å¼•ãå‡ºã—ã¦ãƒ¡ãƒªãƒãƒªã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚æ‰‹å‹•ã§è²¯ã‚ã‚‹/ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p></div>
<div class="help-section"><div class="help-section-title">ğŸ“Š ãã‚ã</div><p>é›†ä¸­æ™‚é–“ã€å®Œäº†ã‚¯ã‚¨ã‚¹ãƒˆæ•°ã€ç²å¾—EXPã€èª˜æƒ‘æ’ƒé€€ã®ç´¯è¨ˆã¨ä»Šæ—¥ã®æ´»å‹•ã‚’ç¢ºèªã§ãã¾ã™ã€‚å®Ÿç¸¾ï¼ˆã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆï¼‰ã¯æ¡ä»¶ã‚’æº€ãŸã™ã¨è‡ªå‹•ã§è§£é™¤ã•ã‚Œã¾ã™ã€‚</p></div>
<div class="help-section"><div class="help-section-title">âš¡ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</div><p><span class="help-highlight">100 EXP</span>ã”ã¨ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</p><p>ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº† â†’ +15 EXPï¼ˆå€‹åˆ¥è¨­å®šå¯ï¼‰</p><p>ãƒ»ã‚¿ã‚¤ãƒãƒ¼å®Œäº† â†’ +25 EXP</p><p>ãƒ»èª˜æƒ‘æ’ƒé€€ â†’ +20 EXP</p><p>ãƒ»å…¨ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ãƒœãƒ¼ãƒŠã‚¹ â†’ +50 EXPï¼ˆ1æ—¥1å›ï¼‰</p></div>
<div class="help-section"><div class="help-section-title">ğŸ“± ã‚¹ãƒãƒ›ã§ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ã†</div><p>iPhone: Safariã§é–‹ã â†’ å…±æœ‰ãƒœã‚¿ãƒ³ â†’ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>Android: Chromeã§é–‹ã â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</p></div>
<div class="help-section"><div class="help-section-title">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦</div><p>ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»åŒã˜URLã§é–‹ã‘ã°ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã‚„åˆ¥ã®ç«¯æœ«ã§ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚</p></div>
</div><div class="mbs"><button class="btn btn-p" onclick="document.getElementById('helpModal').classList.remove('show')" style="width:100%;justify-content:center;">é–‰ã˜ã‚‹</button></div></div></div>

<!-- User Edit Modal -->
<div class="mo" id="ueModal"><div class="mc" style="border-color:var(--accent1);box-shadow:0 0 40px rgba(0,212,255,.2);"><span class="mci">ğŸ‘¤</span><div class="mct" style="color:var(--accent1);" id="ueTitle">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</div><div class="ue-field"><div class="ue-label">ãªã¾ãˆ</div><input class="ue-input" id="ueName" maxlength="10" placeholder="åå‰ã‚’å…¥åŠ›"></div><div class="ue-field"><div class="ue-label">ã‚¢ã‚¤ã‚³ãƒ³</div><div class="ue-emoji-grid" id="ueEmojiGrid"></div></div><div class="ue-field"><div class="ue-label">ãƒ¬ãƒ™ãƒ« / EXPï¼ˆç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰</div><div style="display:flex;gap:8px;align-items:center;"><div style="flex:1;text-align:center;"><div style="font-size:10px;color:var(--text-dim);margin-bottom:4px;">ãƒ¬ãƒ™ãƒ«</div><input type="number" class="ue-input" id="ueLv" min="1" max="999" style="text-align:center;font-family:var(--font-pixel);font-size:14px;"></div><div style="flex:1;text-align:center;"><div style="font-size:10px;color:var(--text-dim);margin-bottom:4px;">EXP</div><input type="number" class="ue-input" id="ueXp" min="0" max="99" style="text-align:center;font-family:var(--font-pixel);font-size:14px;"></div></div><div style="font-size:10px;color:var(--text-dim);margin-top:4px;text-align:center;" id="ueExpNote">â€» 100 EXPã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</div></div><div class="mbs"><button class="btn btn-p" id="ueSave">ä¿å­˜</button><button class="btn btn-g" id="ueCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div></div>

<script>
const CIRC=2*Math.PI*105,XPL=100;
const QA=[{t:"ä»Šã“ã®ç¬é–“ã«é›†ä¸­ã—ã‚ã€‚",a:"ãƒ–ãƒ«ãƒ¼ã‚¹ãƒ»ãƒªãƒ¼"},{t:"å°ã•ãªã“ã¨ã®ç©ã¿é‡ã­ãŒã€ã¨ã‚“ã§ã‚‚ãªã„ã¨ã“ã‚ã¸è¡Œãé“ã€‚",a:"ã‚¤ãƒãƒ­ãƒ¼"},{t:"5åˆ†å¾Œã®è‡ªåˆ†ã«æ„Ÿè¬ã•ã‚Œã‚‹ã“ã¨ã‚’ã—ã‚ˆã†ã€‚",a:""},{t:"YouTubeã¯é€ƒã’ãªã„ã€‚ã§ã‚‚ä»Šã“ã®æ™‚é–“ã¯äºŒåº¦ã¨æˆ»ã‚‰ãªã„ã€‚",a:""},{t:"ã‚µãƒœã‚ŠãŸã„æ°—æŒã¡ã¯ä¸€æ™‚çš„ã€‚é”æˆæ„Ÿã¯ä¸€ç”Ÿã‚‚ã®ã€‚",a:""},{t:"ã€Œã‚ã¨ã§ã€ã¯ã€Œã‚„ã‚‰ãªã„ã€ã¨åŒã˜ã€‚ä»Šã‚„ã‚ã†ã€‚",a:""},{t:"é›†ä¸­ã—ãŸ1æ™‚é–“ã¯ãƒ€ãƒ©ãƒ€ãƒ©ã—ãŸ3æ™‚é–“ã«å‹ã‚‹ã€‚",a:""},{t:"å¾Œæ‚”ã™ã‚‹ã®ã¯æ€ ã‘ãŸæ™‚ã ã‘ã€‚",a:""}];
const QK=[{t:"ä»ŠãŒã‚“ã°ã£ãŸã‚‰ã€ã‚ã¨ã§ã‚‚ã£ã¨æ¥½ã—ããªã‚‹ã‚ˆï¼",a:""},{t:"ã‚²ãƒ¼ãƒ ã¯ã«ã’ãªã„ã€‚ã§ã‚‚ä»Šã®æ™‚é–“ã¯ã‚‚ã©ã‚‰ãªã„ã‚ˆï¼",a:""},{t:"ã‚ã¨å°‘ã—ãŒã‚“ã°ã‚ã†ï¼ãã£ã¨ã§ãã‚‹ã‚ˆï¼",a:""},{t:"ãƒ’ãƒ¼ãƒ­ãƒ¼ã¯ã•ã„ã”ã¾ã§ã‚ãã‚‰ã‚ãªã„ã‚“ã ï¼",a:""},{t:"ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€ã‚„ã‚‹ã¹ãã“ã¨ã®ã‚ã¨ã«å¾…ã£ã¦ã‚‹ã‚ˆï¼",a:""},{t:"ã—ã‚…ã†ã¡ã‚…ã†ã—ãŸã‚ã¨ã®ãŠã‚„ã¤ã¯æœ€é«˜ã ã‚ˆï¼",a:""}];
const ACHS=[{id:'q1',n:'ğŸ—¡ï¸ ã¯ã˜ã‚ã®ä¸€æ­©',d:'ã‚¯ã‚¨ã‚¹ãƒˆ1å®Œäº†',c:s=>s.questsDone>=1},{id:'q5',n:'âš”ï¸ ã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ã‚¿ãƒ¼',d:'ã‚¯ã‚¨ã‚¹ãƒˆ5å®Œäº†',c:s=>s.questsDone>=5},{id:'f1',n:'ğŸ¯ é›†ä¸­ã®ç›®è¦šã‚',d:'ã‚¿ã‚¤ãƒãƒ¼1å›å®Œäº†',c:s=>s.focusSessions>=1},{id:'f10',n:'ğŸ§˜ é›†ä¸­ãƒã‚¹ã‚¿ãƒ¼',d:'ã‚¿ã‚¤ãƒãƒ¼10å›å®Œäº†',c:s=>s.focusSessions>=10},{id:'r1',n:'ğŸ›¡ï¸ åˆæ’ƒé€€',d:'èª˜æƒ‘1å›æ’ƒé€€',c:s=>s.resisted>=1},{id:'r10',n:'ğŸ’ é‰„ã®æ„å¿—',d:'èª˜æƒ‘10å›æ’ƒé€€',c:s=>s.resisted>=10},{id:'l5',n:'ğŸŒŸ Lv.5',d:'ãƒ¬ãƒ™ãƒ«5åˆ°é”',c:s=>s.level>=5},{id:'l10',n:'ğŸ‘‘ Lv.10',d:'ãƒ¬ãƒ™ãƒ«10åˆ°é”',c:s=>s.level>=10},{id:'m60',n:'ğŸ”¥ 1æ™‚é–“é›†ä¸­',d:'åˆè¨ˆ60åˆ†é›†ä¸­',c:s=>s.focusMinutes>=60},{id:'m300',n:'ğŸ† 5æ™‚é–“é›†ä¸­',d:'åˆè¨ˆ300åˆ†é›†ä¸­',c:s=>s.focusMinutes>=300},{id:'s5',n:'ğŸ“‹ è¨ˆç”»çš„',d:'å…¨å®Œäº†ãƒœãƒ¼ãƒŠã‚¹5å›',c:s=>s.bonusCount>=5},{id:'s20',n:'ğŸ“… ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ',d:'å…¨å®Œäº†ãƒœãƒ¼ãƒŠã‚¹20å›',c:s=>s.bonusCount>=20}];
const PROFS={adult:[{id:'a1',e:'âš”ï¸',n:'å†’é™ºè€…'},{id:'a2',e:'ğŸ§™',n:'é­”æ³•ä½¿ã„'}],kids:[{id:'k1',e:'ğŸ¦¸',n:'ãƒ’ãƒ¼ãƒ­ãƒ¼'},{id:'k2',e:'ğŸ±',n:'ãƒã‚³'}]};
const USER_EMOJIS=['ğŸ˜€','ğŸ˜','ğŸ¤“','ğŸ§‘â€ğŸ’»','ğŸ‘©â€ğŸ’»','ğŸ¦¸','ğŸ§™','ğŸ±','ğŸ¶','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¦','ğŸ¸','ğŸ®','âš”ï¸','ğŸŒŸ','ğŸ”¥','ğŸ’','ğŸŒˆ'];
const MAX_USERS=3;

// ========== USER MANAGEMENT ==========
function getUsers(){try{const r=localStorage.getItem('fq_users');if(r)return JSON.parse(r);}catch(e){}return[{id:'u1',name:'ãƒ¦ãƒ¼ã‚¶ãƒ¼1',emoji:'ğŸ˜€'},{id:'u2',name:'ãƒ¦ãƒ¼ã‚¶ãƒ¼2',emoji:'ğŸ˜'},{id:'u3',name:'ãƒ¦ãƒ¼ã‚¶ãƒ¼3',emoji:'ğŸ¤“'}];}
function saveUsers(users){localStorage.setItem('fq_users',JSON.stringify(users));}
function getCurUserId(){return localStorage.getItem('fq_curUser')||'u1';}
function setCurUserId(id){localStorage.setItem('fq_curUser',id);}

let curUserId=getCurUserId();

function rUserSwitcher(){
  const users=getUsers();
  document.getElementById('userSwitcher').innerHTML=users.map(u=>{
    const pid=u.id+'_'+(localStorage.getItem('fq_mode_'+u.id)||'adult')+'_'+(localStorage.getItem('fq_prof_'+u.id)||'a1');
    const data=lp(u.id+'_'+(localStorage.getItem('fq_mode_'+u.id)||'adult')+'_'+(localStorage.getItem('fq_prof_'+u.id)||'a1'));
    return`<button class="user-btn ${u.id===curUserId?'active':''}" onclick="switchUser('${u.id}')"><span class="user-emoji">${u.emoji}</span><span class="user-name">${esc(u.name)}</span><span class="user-lv">Lv.${data.level}</span></button>`;
  }).join('')+`<button class="user-edit-btn" onclick="openUserEdit()" title="ç·¨é›†">âš™ï¸</button>`;
}

function switchUser(uid){
  curUserId=uid;setCurUserId(uid);
  const mode=localStorage.getItem('fq_mode_'+uid)||'adult';
  const prof=localStorage.getItem('fq_prof_'+uid)||(mode==='kids'?'k1':'a1');
  cMode=mode;cPid=uid+'_'+mode+'_'+prof;
  applyMode(mode);
  rProfs();ld();chkDay();rAll();rUserSwitcher();
}

let ueEditingId=null;
function openUserEdit(){
  ueEditingId=curUserId;
  const users=getUsers();const u=users.find(x=>x.id===ueEditingId);
  document.getElementById('ueName').value=u?u.name:'';
  document.getElementById('ueTitle').textContent=cMode==='kids'?'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã›ã£ã¦ã„':'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š';
  const grid=document.getElementById('ueEmojiGrid');
  grid.innerHTML=USER_EMOJIS.map(e=>`<div class="ue-emoji-opt ${u&&u.emoji===e?'sel':''}" onclick="pickUeEmoji(this,'${e}')">${e}</div>`).join('');
  document.getElementById('ueModal').classList.add('show');
  document.getElementById('ueLv').value=S.level;
  document.getElementById('ueXp').value=S.xp;
}
function pickUeEmoji(el,e){document.querySelectorAll('.ue-emoji-opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');}
document.getElementById('ueSave').onclick=()=>{
  const users=getUsers();const u=users.find(x=>x.id===ueEditingId);
  if(u){
    const name=document.getElementById('ueName').value.trim()||u.name;
    const selE=document.querySelector('.ue-emoji-opt.sel');
    u.name=name;if(selE)u.emoji=selE.textContent;
    saveUsers(users);
  }
  const newLv=parseInt(document.getElementById('ueLv').value)||1;
  const newXp=Math.min(99,Math.max(0,parseInt(document.getElementById('ueXp').value)||0));
  S.level=Math.max(1,newLv);S.xp=newXp;sv();
  document.getElementById('ueModal').classList.remove('show');
  rUserSwitcher();uStatus();uStats();rAll();
};
document.getElementById('ueCancel').onclick=()=>document.getElementById('ueModal').classList.remove('show');

let cMode='adult',cPid='u1_adult_a1';
function ds(){return{level:1,xp:0,quests:[],focusMinutes:0,focusSessions:0,questsDone:0,resisted:0,resistStreak:0,streak:0,lastActiveDate:null,achievements:[],todayFocusMin:0,todayQuestsDone:0,todayQuestsTotal:0,todayResisted:0,timeBankMinutes:0,todayBonusClaimed:false,bonusCount:0};}
let S=ds();
function lp(pid){try{const r=localStorage.getItem('fq_'+pid);if(r)return{...ds(),...JSON.parse(r)};}catch(e){}return ds();}
function sp(pid,d){try{localStorage.setItem('fq_'+pid,JSON.stringify(d));}catch(e){}}
function ld(){S=lp(cPid);}function sv(){sp(cPid,S);}

// Mode & Profile
function applyMode(m){
  cMode=m;
  localStorage.setItem('fq_mode_'+curUserId,m);
  if(m==='kids'){document.body.classList.add('theme-kids');document.getElementById('msTrack').classList.add('kids');document.getElementById('lA').classList.remove('active-label');document.getElementById('lK').classList.add('active-label');}
  else{document.body.classList.remove('theme-kids');document.getElementById('msTrack').classList.remove('kids');document.getElementById('lA').classList.add('active-label');document.getElementById('lK').classList.remove('active-label');}
}
function setMode(m){
  applyMode(m);
  const prof=localStorage.getItem('fq_prof_'+curUserId+'_'+m)||(m==='kids'?'k1':'a1');
  localStorage.setItem('fq_prof_'+curUserId,prof);
  cPid=curUserId+'_'+m+'_'+prof;
  rProfs();ld();chkDay();rAll();
}
function selProf(pid){
  localStorage.setItem('fq_prof_'+curUserId+'_'+cMode,pid);
  localStorage.setItem('fq_prof_'+curUserId,pid);
  cPid=curUserId+'_'+cMode+'_'+pid;
  ld();chkDay();rAll();rProfs();rUserSwitcher();
}
function rProfs(){const ps=cMode==='kids'?PROFS.kids:PROFS.adult;const curProf=localStorage.getItem('fq_prof_'+curUserId+'_'+cMode)||(cMode==='kids'?'k1':'a1');document.getElementById('profBar').innerHTML=ps.map(p=>`<button class="profile-btn ${p.id===curProf?'active':''}" onclick="selProf('${p.id}')"><span class="pem">${p.e}</span>${p.n}</button>`).join('');}
document.getElementById('msTrack').onclick=()=>setMode(cMode==='adult'?'kids':'adult');
document.getElementById('lA').onclick=()=>setMode('adult');
document.getElementById('lK').onclick=()=>setMode('kids');

function chkDay(){const t=new Date().toDateString();if(S.lastActiveDate&&S.lastActiveDate!==t){const y=new Date(Date.now()-864e5).toDateString();S.streak=(S.lastActiveDate===y)?S.streak+1:1;S.todayFocusMin=0;S.todayQuestsDone=0;S.todayQuestsTotal=0;S.todayResisted=0;S.todayBonusClaimed=false;const repeats=S.quests.filter(q=>q.repeat).map(q=>({text:q.text,done:false,repeat:true,xp:q.xp||15,days:q.days,cat:q.cat||''}));const undone=S.quests.filter(q=>!q.done&&!q.repeat);S.quests=[...repeats,...undone];S.todayQuestsTotal=S.quests.length;}else if(!S.lastActiveDate){S.streak=1;}S.lastActiveDate=t;sv();}

// XP
function addXP(n){S.xp+=n;let u=false;while(S.xp>=XPL){S.xp-=XPL;S.level++;u=true;}sv();uStatus();sXP(n);if(u)sLU();chkAch();}
function sXP(n){const e=document.createElement('div');e.className='xpp';e.textContent=`+${n} EXP`;document.body.appendChild(e);setTimeout(()=>e.remove(),1400);}
function sLU(){document.getElementById('luL').textContent=`Lv.${S.level}`;const o=document.getElementById('luO');o.classList.add('show');if(navigator.vibrate)navigator.vibrate([100,80,100,80,200]);setTimeout(()=>o.classList.remove('show'),2800);}

// UI helpers
function gP(){const l=cMode==='kids'?PROFS.kids:PROFS.adult;const curProf=localStorage.getItem('fq_prof_'+curUserId+'_'+cMode)||(cMode==='kids'?'k1':'a1');return l.find(p=>p.id===curProf)||l[0];}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function uStatus(){const p=gP();const users=getUsers();const u=users.find(x=>x.id===curUserId);document.getElementById('pAvatar').textContent=u?u.emoji:p.e;document.getElementById('pName').textContent=u?u.name:p.n;document.getElementById('pLevel').textContent=`Lv.${S.level}`;document.getElementById('xpBar').style.width=`${(S.xp/XPL)*100}%`;document.getElementById('strk').textContent=S.streak;}
function uTB(){const h=Math.floor(Math.abs(S.timeBankMinutes)/60),m=Math.abs(S.timeBankMinutes)%60,sg=S.timeBankMinutes<0?'-':'';document.getElementById('tbBal').textContent=`${sg}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;document.getElementById('tbSub').textContent=cMode==='kids'?'ãŒã‚“ã°ã£ãŸæ™‚é–“ã‚’ãŸã‚ã¦ã€ã‚ãã¶æ™‚é–“ã«ã—ã‚ˆã†ï¼':'é›†ä¸­ã—ãŸæ™‚é–“ã‚’è²¯é‡‘ã—ã¦ã€è‡ªç”±æ™‚é–“ã«å¤‰æ›ã—ã‚ˆã†';document.getElementById('tbTT').textContent=cMode==='kids'?'ã˜ã‹ã‚“ãã‚“ã“ã†':'ã‚¿ã‚¤ãƒ ãƒãƒ³ã‚¯';}
function uShield(){document.getElementById('resC').textContent=S.resisted;document.getElementById('resS').textContent=S.resistStreak;if(cMode==='kids'){document.getElementById('shE').textContent='ğŸ¦¸';document.getElementById('shM').innerHTML='ã‚†ã†ã‚ããŒããŸã‚‰<br>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ï¼';document.getElementById('shS').textContent='ã‚²ãƒ¼ãƒ ã‚„ã©ã†ãŒã‚’è¦‹ãŸããªã£ãŸã‚‰ãŠã—ã¦ã­';document.getElementById('tmpBtn').textContent='ğŸ˜ˆ ãŸã™ã‘ã¦ï¼ã‚†ã†ã‚ããŒããŸï¼';}else{document.getElementById('shE').textContent='ğŸ›¡ï¸';document.getElementById('shM').innerHTML='èª˜æƒ‘ã«è² ã‘ãã†ã«ãªã£ãŸã‚‰<br>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ï¼';document.getElementById('shS').textContent='YouTubeã‚„SNSã‚’è¦‹ãŸããªã£ãŸã‚‰æŠ¼ã—ã¦ã­';document.getElementById('tmpBtn').textContent='ğŸ˜ˆ èª˜æƒ‘ãŒæ¥ãŸï¼åŠ©ã‘ã¦ï¼';}}
function uStats(){document.getElementById('stF').textContent=S.focusMinutes;document.getElementById('stQ').textContent=S.questsDone;document.getElementById('stX').textContent=S.level*XPL+S.xp;document.getElementById('stR').textContent=S.resisted;document.getElementById('lgFB').style.width=Math.min(100,(S.todayFocusMin/120)*100)+'%';document.getElementById('lgFV').textContent=S.todayFocusMin+'åˆ†';const qP=S.todayQuestsTotal>0?(S.todayQuestsDone/S.todayQuestsTotal)*100:0;document.getElementById('lgQB').style.width=qP+'%';document.getElementById('lgQV').textContent=`${S.todayQuestsDone}/${S.todayQuestsTotal}`;document.getElementById('lgRB').style.width=Math.min(100,(S.todayResisted/10)*100)+'%';document.getElementById('lgRV').textContent=S.todayResisted+'å›';}
function rAch(){document.getElementById('achList').innerHTML='<div class="st" style="margin-bottom:10px">ğŸ† å®Ÿç¸¾</div>'+ACHS.map(a=>{const u=S.achievements.includes(a.id);return`<div class="ach ${u?'ul':'lk'}"><div class="ai">${a.n.split(' ')[0]}</div><div class="af"><div class="an">${a.n}</div><div class="ad">${a.d}</div></div></div>`;}).join('');}
function chkAch(){let c=false;ACHS.forEach(a=>{if(!S.achievements.includes(a.id)&&a.c(S)){S.achievements.push(a.id);c=true;}});if(c){sv();rAch();}}
function rAll(){uStatus();uTB();rQuests();uTmDisp();uShield();uStats();rAch();chkAch();}

// Quests
const DAYS=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
const CATS=[{id:'',label:'âš”ï¸ å…¨éƒ¨',labelK:'âš”ï¸ ãœã‚“ã¶'},{id:'health',label:'ğŸ¥ å¥åº·',labelK:'ğŸ¥ ã‘ã‚“ã“ã†'},{id:'study',label:'ğŸ“š å‹‰å¼·',labelK:'ğŸ“š ã¹ã‚“ãã‚‡ã†'}];
let qFilter='';
function initDayBtns(containerId,selected){
  const c=document.getElementById(containerId);if(!c)return;
  c.innerHTML=DAYS.map((d,i)=>`<button class="day-btn ${(selected||[]).includes(i)?'sel':''}" data-day="${i}" onclick="this.classList.toggle('sel')">${d}</button>`).join('');
}
function initAddDays(){initDayBtns('qDaysRow',[0,1,2,3,4,5,6]);}
initAddDays();
function getDaysFromContainer(containerId){
  const btns=document.querySelectorAll('#'+containerId+' .day-btn.sel');
  return Array.from(btns).map(b=>parseInt(b.dataset.day));
}
function dayLabel(days){
  if(!days||days.length===0)return '';
  if(days.length===7)return 'ğŸ”æ¯æ—¥';
  return 'ğŸ”'+days.map(d=>DAYS[d]).join('');
}
function catLabel(cat){
  if(cat==='health')return '<span class="q-cat q-cat-health">ğŸ¥</span>';
  if(cat==='study')return '<span class="q-cat q-cat-study">ğŸ“š</span>';
  return '';
}
function catName(cat){
  const c=CATS.find(x=>x.id===cat);
  return c?(cMode==='kids'?c.labelK:c.label):'';
}
function setQFilter(f){qFilter=f;rQuests();}
function rFilters(){
  document.getElementById('qFilters').innerHTML=CATS.map(c=>
    `<button class="q-fil ${qFilter===c.id?'active':''}" onclick="setQFilter('${c.id}')">${cMode==='kids'?c.labelK:c.label}</button>`
  ).join('');
}

let editingIdx=-1;
function rQuests(){const el=document.getElementById('qList');const today=new Date().getDay();
rFilters();
// Filter by day
let visible=S.quests.map((q,i)=>({q,i})).filter(({q})=>!q.repeat||!q.days||q.days.length===0||q.days.includes(today));
// Filter by category
if(qFilter){visible=visible.filter(({q})=>(q.cat||'')===qFilter);}
const allToday=S.quests.map((q,i)=>({q,i})).filter(({q})=>!q.repeat||!q.days||q.days.length===0||q.days.includes(today));
if(S.quests.length===0){const m=cMode==='kids'?'ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¤ã„ã‹ã—ã¦ ã¼ã†ã‘ã‚“ã‚’ã¯ã˜ã‚ã‚ˆã†ï¼':'ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦å†’é™ºã‚’å§‹ã‚ã‚ˆã†ï¼';el.innerHTML=`<div class="qe"><span class="ei">ğŸ—¡ï¸</span>${m}</div>`;return;}
if(visible.length===0){el.innerHTML=`<div class="qe"><span class="ei">ğŸ“‹</span>${cMode==='kids'?'ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ãªã„ã‚ˆ':'ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“'}</div>`;return;}
const allDone=allToday.length>0&&allToday.every(({q})=>q.done);
el.innerHTML=visible.map(({q,i})=>{
const xp=q.xp||15;
if(editingIdx===i){const rChk=q.repeat?'checked':'';return`<div class="qc"><div style="flex:1;display:flex;flex-direction:column;gap:6px;"><input class="q-edit-input" id="qEditInp" value="${esc(q.text)}" maxlength="100"><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text-dim);"><span>âš¡</span><input type="number" id="qEditXp" value="${xp}" min="1" max="999" style="width:46px;padding:3px 4px;background:var(--bg-card2);border:1px solid var(--border-glow);border-radius:6px;color:var(--text-main);font-family:var(--font-pixel);font-size:9px;text-align:center;outline:none;"></label><select id="qEditCat" style="padding:3px 6px;background:var(--bg-card2);border:1px solid var(--border-glow);border-radius:6px;color:var(--text-main);font-family:var(--font-body);font-size:11px;outline:none;"><option value="" ${!(q.cat)?'selected':''}>âš”ï¸ é€šå¸¸</option><option value="health" ${q.cat==='health'?'selected':''}>ğŸ¥ å¥åº·</option><option value="study" ${q.cat==='study'?'selected':''}>ğŸ“š å‹‰å¼·</option></select><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--accent5);cursor:pointer;"><input type="checkbox" id="qEditRepeat" ${rChk} style="accent-color:var(--accent5);width:14px;height:14px;" onchange="document.getElementById('qEditDaysRow').style.display=this.checked?'flex':'none'">ğŸ”</label></div><div id="qEditDaysRow" style="${q.repeat?'display:flex':'display:none'};gap:4px;flex-wrap:wrap;"></div></div><div class="q-actions" style="flex-direction:column;"><button class="qed" onclick="saveEdit(${i})" title="ä¿å­˜">âœ“</button><button class="qed" onclick="cancelEdit()" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">âœ•</button></div></div>`;}
const rp=q.repeat?`<span class="q-days-mini">${dayLabel(q.days)}</span>`:'';
const ct=catLabel(q.cat);
return`<div class="qc ${q.done?'done':''}"><button class="qk" onclick="tglQ(${i})">${q.done?'âœ“':''}</button><span class="qt">${esc(q.text)}${ct}${rp}</span><span class="qx">${q.done?'âœ“':'+'+xp}</span><div class="q-actions"><button class="qed" onclick="startEdit(${i})" title="ç·¨é›†">âœï¸</button><button class="qd" onclick="delQ(${i})" title="å‰Šé™¤">Ã—</button></div></div>`;}).join('')+(allDone&&!S.todayBonusClaimed?`<div style="text-align:center;margin-top:14px;padding:16px;background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,230,0,.05));border:2px solid var(--gold);border-radius:var(--radius);animation:tabIn .3s ease;"><div style="font-size:32px;margin-bottom:8px;">ğŸ†</div><div style="font-family:var(--font-pixel);font-size:11px;color:var(--gold);margin-bottom:10px;">${cMode==='kids'?'ãœã‚“ã¶ã§ããŸï¼ã™ã”ã„ï¼':'ALL QUEST COMPLETE!'}</div><button class="btn btn-p" onclick="claimBonus()" style="margin:0 auto;display:flex;">${cMode==='kids'?'â­ ãƒœãƒ¼ãƒŠã‚¹ã‚‚ã‚‰ã†ï¼':'â­ ãƒœãƒ¼ãƒŠã‚¹ +50 EXP'}</button></div>`:'')+(allDone&&S.todayBonusClaimed?`<div style="text-align:center;margin-top:14px;padding:12px;border-radius:var(--radius);background:rgba(57,255,20,.06);border:1px solid rgba(57,255,20,.15);"><span style="font-family:var(--font-pixel);font-size:10px;color:var(--accent3);">${cMode==='kids'?'âœ… ãƒœãƒ¼ãƒŠã‚¹ã‚²ãƒƒãƒˆï¼ãˆã‚‰ã„ï¼':'âœ… å…¨å®Œäº†ãƒœãƒ¼ãƒŠã‚¹ç²å¾—æ¸ˆã¿ï¼'}</span></div>`:'');
if(editingIdx>=0){const inp=document.getElementById('qEditInp');if(inp){inp.focus();inp.onkeydown=e=>{if(e.key==='Enter')saveEdit(editingIdx);if(e.key==='Escape')cancelEdit();};}
const q=S.quests[editingIdx];initDayBtns('qEditDaysRow',q.days||[0,1,2,3,4,5,6]);}}
function startEdit(i){editingIdx=i;rQuests();}
function cancelEdit(){editingIdx=-1;rQuests();}
function saveEdit(i){const inp=document.getElementById('qEditInp');const rp=document.getElementById('qEditRepeat');const xpInp=document.getElementById('qEditXp');const catInp=document.getElementById('qEditCat');const t=inp?inp.value.trim():'';if(t){S.quests[i].text=t;S.quests[i].repeat=rp?rp.checked:false;S.quests[i].xp=Math.max(1,parseInt(xpInp?.value)||15);S.quests[i].cat=catInp?catInp.value:'';if(rp&&rp.checked){S.quests[i].days=getDaysFromContainer('qEditDaysRow');}else{delete S.quests[i].days;}sv();}editingIdx=-1;rQuests();}
function claimBonus(){S.todayBonusClaimed=true;S.bonusCount=(S.bonusCount||0)+1;sv();rQuests();addXP(50);}
function addQ(){const inp=document.getElementById('qInp');const t=inp.value.trim();if(!t)return;const repeat=document.getElementById('qRepeat').checked;const xp=Math.max(1,parseInt(document.getElementById('qExpInp').value)||15);const cat=document.getElementById('qCatInp').value;const q={text:t,done:false,repeat:repeat,xp:xp,cat:cat};if(repeat){q.days=getDaysFromContainer('qDaysRow');}S.quests.push(q);S.todayQuestsTotal++;inp.value='';document.getElementById('qRepeat').checked=false;document.getElementById('qDaysRow').style.display='none';document.getElementById('qExpInp').value='15';document.getElementById('qCatInp').value='';initAddDays();sv();rQuests();uStats();}
function tglQ(i){const q=S.quests[i];const xp=q.xp||15;if(!q.done){q.done=true;S.questsDone++;S.todayQuestsDone++;sv();rQuests();uStats();addXP(xp);}else{q.done=false;S.questsDone=Math.max(0,S.questsDone-1);S.todayQuestsDone=Math.max(0,S.todayQuestsDone-1);sv();rQuests();uStats();}}
function delQ(i){S.quests.splice(i,1);sv();rQuests();uStats();}
document.getElementById('addQ').onclick=addQ;
document.getElementById('qInp').onkeydown=e=>{if(e.key==='Enter')addQ();};

// Timer
const ring=document.getElementById('tmRing');
let ti=null,tR=false,tS=15*60,tT=15*60,tB=false,tSn=1;const TSN=4;
function uTmDisp(){const mm=String(Math.floor(tS/60)).padStart(2,'0'),ss=String(tS%60).padStart(2,'0'),el=document.getElementById('tmTime');el.textContent=`${mm}:${ss}`;const p=tT>0?(tS/tT):1;ring.style.strokeDasharray=CIRC;ring.style.strokeDashoffset=CIRC*(1-p);const isU=tS<=60&&tS>0&&tR&&!tB,isC=tS<=30&&tS>0&&tR&&!tB;el.classList.toggle('urgent',isU);ring.classList.toggle('urgent',isU);ring.classList.toggle('br',tB);const dl=document.getElementById('tmDead');if(tR&&!tB){dl.classList.remove('hid');if(isC){dl.textContent=cMode==='kids'?`ã‚ã¨${tS}ã³ã‚‡ã†ï¼ãŒã‚“ã°ã‚Œï¼`:`ãƒ©ã‚¹ãƒˆ${tS}ç§’ï¼è¸ã‚“å¼µã‚Œï¼`;dl.className='tdl ut';}else if(isU){dl.textContent=cMode==='kids'?`ã‚ã¨${Math.ceil(tS/60)}ã·ã‚“ï¼ã‚‚ã†ã™ã“ã—ï¼`:`ç· ã‚åˆ‡ã‚Šã¾ã§ã‚ã¨${Math.ceil(tS/60)}åˆ†ï¼`;dl.className='tdl ut';}else{dl.textContent=cMode==='kids'?`ã®ã“ã‚Š${Math.ceil(tS/60)}ã·ã‚“ ãƒ•ã‚¡ã‚¤ãƒˆï¼`:`ç· ã‚åˆ‡ã‚Šã¾ã§ã‚ã¨${Math.ceil(tS/60)}åˆ†`;dl.className='tdl';}}else if(tR&&tB){dl.classList.remove('hid');dl.textContent=cMode==='kids'?'ãã‚…ã†ã‘ã„ã¡ã‚…ã†ã€œ ğŸµ':'ä¼‘æ†©ä¸­...â˜•';dl.className='tdl';}else{dl.classList.add('hid');}const ml=document.getElementById('tmLabel');if(tB){ml.textContent=cMode==='kids'?'â˜• ãã‚…ã†ã‘ã„ã‚¿ã‚¤ãƒ ':'â˜• BREAK TIME';ml.className='tml bm';}else{ml.textContent=cMode==='kids'?'âš”ï¸ ã—ã‚…ã†ã¡ã‚…ã†ãƒ¢ãƒ¼ãƒ‰':'âš”ï¸ FOCUS MODE';ml.className='tml';}const dots=document.getElementById('sDots');dots.innerHTML='';for(let i=1;i<=TSN;i++){const d=document.createElement('div');d.className='sd';if(i<tSn)d.classList.add('dn');if(i===tSn)d.classList.add('cur');dots.appendChild(d);}}

function strTm(){if(tR){clearInterval(ti);tR=false;const b=document.getElementById('tmStr');b.textContent='â–¶';b.className='bt bts';uTmDisp();return;}tR=true;const b=document.getElementById('tmStr');b.textContent='â¸';b.className='bt btp';ti=setInterval(()=>{tS--;if(tS<=0){clearInterval(ti);tR=false;b.textContent='â–¶';b.className='bt bts';onTmDn();}uTmDisp();},1000);}

function onTmDn(){if(!tB){const mins=Math.round(tT/60);S.focusMinutes+=mins;S.todayFocusMin+=mins;S.focusSessions++;S.timeBankMinutes+=mins;if(navigator.vibrate)navigator.vibrate([200,100,200,100,200]);sv();uStats();uTB();showCel(mins);if(tSn<TSN){tB=true;tS=5*60;tT=5*60;}else{tB=true;tS=15*60;tT=15*60;tSn=0;}}else{tB=false;tSn++;if(tSn>TSN)tSn=1;tS=gPM()*60;tT=tS;}uTmDisp();}

function showCel(mins){const o=document.getElementById('celO');o.classList.add('show');o.innerHTML='';const cs=['#ff2d95','#00d4ff','#39ff14','#ffe600','#b24dff','#ffd700'];for(let i=0;i<60;i++){const c=document.createElement('div');const x=Math.random()*100,dl=Math.random()*.5,du=1+Math.random()*2,cl=cs[Math.floor(Math.random()*cs.length)],sz=6+Math.random()*8;c.style.cssText=`position:absolute;left:${x}%;top:-10px;width:${sz}px;height:${sz}px;background:${cl};border-radius:${Math.random()>.5?'50%':'2px'};animation:confettiFall ${du}s ${dl}s ease-in forwards;opacity:0;`;o.appendChild(c);}setTimeout(()=>o.classList.remove('show'),3000);const m=document.getElementById('compM');const icons=['ğŸ‰','ğŸ†','â­','ğŸ”¥','ğŸ’ª','ğŸŠ'];document.getElementById('compI').textContent=icons[Math.floor(Math.random()*icons.length)];if(cMode==='kids'){document.getElementById('compT').textContent='ã™ã”ã„ï¼ã‚„ã£ãŸã­ï¼';document.getElementById('compX').textContent='+25 ã‘ã„ã‘ã‚“ã¡ï¼';document.getElementById('compB').textContent=`â° ã˜ã‹ã‚“ãã‚“ã“ã†ã«${mins}ã·ã‚“ ã¡ã‚‡ãã‚“ï¼`;}else{document.getElementById('compT').textContent='MISSION COMPLETE!';document.getElementById('compX').textContent='+25 EXP';document.getElementById('compB').textContent=`â° ã‚¿ã‚¤ãƒ ãƒãƒ³ã‚¯ã«${mins}åˆ†è²¯é‡‘ï¼`;}m.classList.add('show');}
document.getElementById('compBtn').onclick=()=>{document.getElementById('compM').classList.remove('show');addXP(25);};
function rstTm(){clearInterval(ti);tR=false;tB=false;tSn=1;tS=gPM()*60;tT=tS;document.getElementById('tmStr').textContent='â–¶';document.getElementById('tmStr').className='bt bts';uTmDisp();}
function gPM(){const a=document.querySelector('.tp.active');return a?parseInt(a.dataset.minutes):15;}
document.getElementById('tmStr').onclick=strTm;document.getElementById('tmRst').onclick=rstTm;
document.querySelectorAll('.tp').forEach(b=>{b.onclick=()=>{if(tR)return;document.querySelectorAll('.tp').forEach(x=>x.classList.remove('active'));b.classList.add('active');tB=b.dataset.break==='true';tS=parseInt(b.dataset.minutes)*60;tT=tS;uTmDisp();};});

// Shield
let cdI=null;
document.getElementById('tmpBtn').onclick=()=>{const qs=cMode==='kids'?QK:QA;const q=qs[Math.floor(Math.random()*qs.length)];document.getElementById('tmQ').textContent=`"${q.t}"`;document.getElementById('tmA').textContent=q.a?`â€” ${q.a}`:'';document.getElementById('tmT').textContent=cMode==='kids'?'ã‚†ã†ã‚ãã‚¢ãƒ©ãƒ¼ãƒˆï¼':'èª˜æƒ‘ã‚¢ãƒ©ãƒ¼ãƒˆï¼';document.getElementById('tmCDL').textContent=cMode==='kids'?'ã¾ã£ã¦...ã—ã‚“ã“ãã‚…ã†ã—ã¦':'å†·å´ã‚¿ã‚¤ãƒ ...æ·±å‘¼å¸ã—ã¦';document.getElementById('tmpModal').classList.add('show');let cd=10;document.getElementById('tmCD').textContent=cd;document.getElementById('resBtn').disabled=true;document.getElementById('resBtn').style.opacity='.5';cdI=setInterval(()=>{cd--;document.getElementById('tmCD').textContent=cd;if(cd<=0){clearInterval(cdI);document.getElementById('resBtn').disabled=false;document.getElementById('resBtn').style.opacity='1';document.getElementById('tmCD').textContent='âœ“';}},1000);};
document.getElementById('resBtn').onclick=()=>{clearInterval(cdI);document.getElementById('tmpModal').classList.remove('show');S.resisted++;S.resistStreak++;S.todayResisted++;sv();uShield();uStats();addXP(20);};
document.getElementById('gavBtn').onclick=()=>{clearInterval(cdI);document.getElementById('tmpModal').classList.remove('show');S.resistStreak=0;sv();uShield();};

// TB Modal
let tbAmt=0,tbW=false;
document.getElementById('tbDep').onclick=()=>{tbW=false;tbAmt=0;openTB();};
document.getElementById('tbWith').onclick=()=>{tbW=true;tbAmt=0;openTB();};
function openTB(){const mc=document.getElementById('tbMC');mc.classList.toggle('wm',tbW);document.getElementById('tbMI').textContent=tbW?'ğŸ®':'ğŸ¦';if(tbW){document.getElementById('tbMT').textContent=cMode==='kids'?'ã˜ã‹ã‚“ã‚’ã¤ã‹ã†':'æ™‚é–“ã‚’ä½¿ã†';document.querySelectorAll('.tbab').forEach(b=>{b.textContent='-'+b.dataset.min+'åˆ†';});}else{document.getElementById('tbMT').textContent=cMode==='kids'?'ã˜ã‹ã‚“ã‚’ãŸã‚ã‚‹':'æ™‚é–“ã‚’è²¯ã‚ã‚‹';document.querySelectorAll('.tbab').forEach(b=>{b.textContent='+'+b.dataset.min+'åˆ†';});}uTBAD();document.getElementById('tbMod').classList.add('show');}
function uTBAD(){const h=Math.floor(tbAmt/60),m=tbAmt%60;document.getElementById('tbAD').textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
document.querySelectorAll('.tbab').forEach(b=>{b.onclick=()=>{tbAmt+=parseInt(b.dataset.min);if(tbAmt<0)tbAmt=0;uTBAD();};});
document.getElementById('tbOK').onclick=()=>{if(tbAmt>0){if(tbW)S.timeBankMinutes-=tbAmt;else S.timeBankMinutes+=tbAmt;sv();uTB();}document.getElementById('tbMod').classList.remove('show');};
document.getElementById('tbCan').onclick=()=>document.getElementById('tbMod').classList.remove('show');

// Tabs
document.querySelectorAll('.nav-tab').forEach(t=>{t.onclick=()=>{document.querySelectorAll('.nav-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tc').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById('tab-'+t.dataset.tab).classList.add('active');};});

// Reset
document.getElementById('rstBtn').onclick=()=>{if(confirm(cMode==='kids'?'ãƒ‡ãƒ¼ã‚¿ã‚’ãœã‚“ã¶ã‘ã—ã¾ã™ã‹ï¼Ÿ':'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){S=ds();sv();rAll();}};

// PWA
function setupMF(){const m={name:"Focus Quest",short_name:"FocusQuest",description:"é›†ä¸­åŠ›ã‚¢ãƒƒãƒ—ã‚¢ãƒ—ãƒª",start_url:".",display:"standalone",background_color:"#0a0a1a",theme_color:"#0a0a1a",icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>âš”ï¸</text></svg>",sizes:"any",type:"image/svg+xml"}]};document.getElementById('manifestLink').href=URL.createObjectURL(new Blob([JSON.stringify(m)],{type:'application/json'}));}
function regSW(){if('serviceWorker'in navigator){const c="self.addEventListener('install',e=>{self.skipWaiting();});self.addEventListener('activate',e=>{e.waitUntil(clients.claim());});self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>new Response('Offline')));});";navigator.serviceWorker.register(URL.createObjectURL(new Blob([c],{type:'application/javascript'}))).catch(()=>{});}}

function init(){setupMF();regSW();curUserId=getCurUserId();switchUser(curUserId);}
init();
</script>
</body>
</html>
